
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MJ üèÜ ÊúâË≥≠Êú™ÁÇ∫Ëº∏</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="wrap">
    <h1>üèÜ ÊúâË≥≠Êú™ÁÇ∫Ëº∏</h1>

    <!-- Tabs -->
    <div class="tabs">
      <button class="on" id="tab-dashboard">Dashboard</button>
      <button id="tab-detail">Detail</button>
      <button id="tab-admin">Admin</button>
    </div>


    <!-- DASHBOARD -->
    <div id="view-dashboard" class="card">
      <div id="dash-note" class="note">Loading‚Ä¶</div>
      <table class="nice" id="dash-table" style="display:none">
        <thead>
          <tr>
            <th>Player</th>
            <th>Total</th>
            <th>Wins</th>
            <th>Games</th>
            <th>Win %</th>
          </tr>
        </thead>
        <tbody id="dash-body"></tbody>
      </table>
    </div>

    <!-- DETAIL VIEW -->
    <div id="view-detail" class="card" style="display:none">
      <h3>Detail</h3>
      <div id="detail-note" class="note">Loading‚Ä¶</div>
    
      <div id="detail-table-wrapper" class="scroll" style="display:none">
        <table class="nice wide">
          <thead id="detail-head"></thead>
          <tbody id="detail-body"></tbody>
        </table>
      </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="view-admin" class="card" style="display:none">
      <h3>Admin</h3>

      <!-- Login form -->
      <div id="admin-login">
        <input type="password" id="admin-pass" placeholder="Enter admin password"/>
        <button id="btn-login">Login</button>
      </div>

      <!-- Actual admin controls (hidden until login) -->
      <div id="admin-panel" style="display:none">
        
        <h4>Add player</h4>
        <input id="p-name" placeholder="Name"/>
        <input id="p-icon" placeholder="Icon (üéØ üèÜ ‚öΩ)"/>
        <button id="btn-add-player">Save Player</button>

        <h4 style="margin-top:16px">New Game Entry</h4>
        <input type="date" id="game-date" />
        <input id="note" placeholder="Optional note"/>

        <div id="players-list" class="row"></div>
        <div id="per-player"></div>

        <button id="btn-save-entry" disabled>Save Entry</button>
      </div>
    </div>
  </div>

  <!-- ALL JAVASCRIPT HERE -->
  <script>
    // -------------------------------
    // DASHBOARD HELPERS
    // -------------------------------
    const fmtSign = n => n > 0 ? "+" + n : "" + n;
    const color = n => n > 0 ? "green" : n < 0 ? "red" : "gray";

    // Load scoreboard
    async function loadDashboard() {
      try {
        const r = await fetch("/api/stats");
        const rows = await r.json();

        const note = document.getElementById("dash-note");
        const table = document.getElementById("dash-table");
        const body = document.getElementById("dash-body");

        if (!rows.length) {
          note.textContent = "No data yet.";
          table.style.display = "none";
          return;
        }

        note.style.display = "none";
        table.style.display = "";
        body.innerHTML = "";

        rows.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.icon} ${r.name}</td>
            <td style="color:${color(r.total_points)};font-weight:700">${fmtSign(r.total_points)}</td>
            <td>${r.wins}</td>
            <td>${r.games_played}</td>
            <td>${(r.win_pct*100).toFixed(1)}%</td>
          `;
          body.appendChild(tr);
        });
      } catch (e) {
        document.getElementById("dash-note").textContent = "Error loading dashboard.";
      }
    }

    // Run dashboard
    loadDashboard();


    // Shortcuts
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));


    // -------------------------------
    // TAB BEHAVIOR
    // -------------------------------
    $("#tab-dashboard").addEventListener("click", () => {
      $("#tab-dashboard").classList.add("on");
      $("#tab-admin").classList.remove("on");

      $("#view-dashboard").style.display = "";
      $("#view-admin").style.display = "none";
    });

    $("#tab-admin").addEventListener("click", () => {
      $("#tab-admin").classList.add("on");
      $("#tab-dashboard").classList.remove("on");

      $("#view-dashboard").style.display = "none";
      $("#view-admin").style.display = "";
    });


    $("#tab-detail").addEventListener("click", () => {
      $("#tab-dashboard").classList.remove("on");
      $("#tab-admin").classList.remove("on");
      $("#tab-detail").classList.add("on");
    
      $("#view-dashboard").style.display = "none";
      $("#view-admin").style.display = "none";
      $("#view-detail").style.display = "";
    
      loadDetail();
    });

    // -------------------------------
    // ADMIN LOGIN
    // -------------------------------
    $("#btn-login").addEventListener("click", async () => {
      const password = $("#admin-pass").value;

      const r = await fetch("/api/auth/login", {
        method: "POST",
        headers: {"content-type": "application/json"},
        body: JSON.stringify({ password })
      });

      const data = await r.json();

      if (data.ok) {
        $("#admin-login").style.display = "none";
        $("#admin-panel").style.display = "";
        await loadPlayersForAdmin();
      } else {
        alert("Incorrect password");
      }
    });


    // -------------------------------
    // LOADING PLAYERS IN ADMIN PANEL
    // -------------------------------
    async function loadPlayersForAdmin() {
      const r = await fetch("/api/players");
      const players = await r.json();

      const list = $("#players-list");
      list.innerHTML = "";

      players.forEach(p => {
        const label = document.createElement("label");
        label.textContent = `${p.icon} ${p.name}`;
        label.className = "pill";
        label.dataset.id = p.id;

        label.addEventListener("click", () => {
          label.classList.toggle("on");
          renderPlayerInputs(players);
        });

        list.appendChild(label);
      });

      // Add player
      $("#btn-add-player").onclick = async () => {
        const name = $("#p-name").value.trim();
        const icon = $("#p-icon").value.trim() || null;

        if (!name) return alert("Name required");

        await fetch("/api/players", {
          method: "POST",
          headers: {"content-type": "application/json"},
          body: JSON.stringify({ name, icon })
        });

        $("#p-name").value = "";
        $("#p-icon").value = "";

        await loadPlayersForAdmin();
        await loadDashboard();
      };


      // Render inputs for selected players
      function renderPlayerInputs(players) {
        const selected = $$("#players-list .pill.on").map(x => Number(x.dataset.id));

        const box = $("#per-player");
        box.innerHTML = "";

        $("#btn-save-entry").disabled = !selected.length;

        const half = Math.max(1, Math.floor(selected.length / 2));

        selected.forEach((id, idx) => {
          const p = players.find(x => x.id === id);

          const row = document.createElement("div");
          row.className = "row";

          row.innerHTML = `
            <label style="min-width:120px">${p.name}</label>
            <input type="number" data-id="${id}" value="${idx < half ? 5 : -5}">
          `;

          box.appendChild(row);
        });
      }


      // Save entry
      $("#btn-save-entry").onclick = async () => {
        const inputs = $$("#per-player input");

        const items = inputs.map(inp => ({
          player_id: Number(inp.dataset.id),
          points: Number(inp.value || 0)
        }));

        const note = $("#note").value;
        const game_date = $("#game-date").value || undefined;

        await fetch("/api/entries", {
          method: "POST",
          headers: {"content-type":"application/json"},
          body: JSON.stringify({ items, note, game_date })
        });

        alert("Saved!");

        $("#note").value = "";
        $("#per-player").innerHTML = "";
        $("#btn-save-entry").disabled = true;

        $$("#players-list .pill.on").forEach(el => el.classList.remove("on"));

        loadDashboard();
      };
    }
    // -------------------------------
    // DETAIL TAB: Pivot table builder (sortable)
    // -------------------------------
    // We'll keep state across re-renders here:
    const detailState = {
      rows: [],        // raw /api/entries rows
      games: [],       // pivoted game rows
      players: [],     // all player names (columns)
      sortKey: 'Date', // current column key
      sortDir: 'desc'  // 'asc' | 'desc'
    };
  
    async function loadDetail() {
      try {
        const r = await fetch("/api/entries");
        const rows = await r.json();
        detailState.rows = rows;
  
        const note = document.getElementById("detail-note");
        const wrap = document.getElementById("detail-table-wrapper");
        const thead = document.getElementById("detail-head");
        const tbody = document.getElementById("detail-body");
  
        if (!rows.length) {
          note.textContent = "No entries yet.";
          wrap.style.display = "none";
          return;
        }
  
        note.style.display = "none";
        wrap.style.display = "";
  
        // Build pivot (group by entry_id)
        const gamesMap = new Map();
        rows.forEach(r => {
          // Format date as dd-MMM-yy (UTC)
          const dateFmt = new Date(r.entry_ts + "Z").toLocaleDateString("en-GB", {
            day: "2-digit", month: "short", year: "2-digit", timeZone: "UTC"
          }).replace(/ /g, "-");
  
          if (!gamesMap.has(r.entry_id)) {
            gamesMap.set(r.entry_id, { Date: dateFmt, Game: r.entry_id });
          }
          gamesMap.get(r.entry_id)[r.name] = r.points;
        });
  
        // All player columns (sorted A‚ÜíZ)
        const players = Array.from(new Set(rows.map(r => r.name)))
          .sort((a,b) => a.localeCompare(b, undefined, { sensitivity: "base" }));
  
        // Array of game rows
        const games = Array.from(gamesMap.values());
  
        // Save state
        detailState.players = players;
        detailState.games   = games;
  
        // Build header with clickable th
        const headerHtml = `
          <tr>
            <th data-key="Date">Date</th>
            <th data-key="Game">Game</th>
            ${players.map(p => `<th data-key="${escapeHtml(p)}">${escapeHtml(p)}</th>`).join("")}
          </tr>
        `;
        thead.innerHTML = headerHtml;
  
        // Attach click handlers for sorting
        thead.querySelectorAll("th").forEach(th => {
          th.addEventListener("click", () => {
            const key = th.getAttribute("data-key");
            if (!key) return;
  
            // Toggle direction if same key; else default to desc for Date/Game, asc for players
            if (detailState.sortKey === key) {
              detailState.sortDir = (detailState.sortDir === "asc" ? "desc" : "asc");
            } else {
              detailState.sortKey = key;
              detailState.sortDir = (key === "Date" || key === "Game") ? "desc" : "desc";
            }
  
            renderDetailTable();
          });
        });
  
        // First render (default: newest first by Date or Game)
        detailState.sortKey = "Date";
        detailState.sortDir = "desc";
        renderDetailTable();
  
        function renderDetailTable() {
          const { games, players, sortKey, sortDir } = detailState;
  
          // Prepare a copy to sort
          const data = games.slice();
  
          // Sorting rules:
          // - Date: compare actual dates (newest first if desc)
          // - Game: numeric sort
          // - Player columns: numeric sort (points), missing -> 0
          data.sort((a, b) => {
            const dir = (sortDir === "asc" ? 1 : -1);
  
            if (sortKey === "Date") {
              // Parse dd-MMM-yy ‚Üí Date
              const parse = (s) => new Date(s.replace(/-/g, ' ')); // quick parse; acceptable here
              const va = parse(a.Date).getTime();
              const vb = parse(b.Date).getTime();
              return (va - vb) * dir;
            }
  
            if (sortKey === "Game") {
              const va = Number(a.Game) || 0;
              const vb = Number(b.Game) || 0;
              return (va - vb) * dir;
            }
  
            // Player column (numeric points; default 0 when missing)
            const va = Number(a[sortKey] ?? 0);
            const vb = Number(b[sortKey] ?? 0);
            return (va - vb) * dir;
          });
  
          // Render body
          tbody.innerHTML = data.map(g => `
            <tr>
              <td>${g.Date}</td>
              <td>${g.Game}</td>
              ${players.map(p => `<td>${Number(g[p] ?? 0)}</td>`).join("")}
            </tr>
          `).join("");
  
          // Update header indicators
          thead.querySelectorAll("th").forEach(th => th.classList.remove("sort-asc", "sort-desc"));
          const active = thead.querySelector(`th[data-key="${cssEscape(detailState.sortKey)}"]`);
          if (active) active.classList.add(detailState.sortDir === "asc" ? "sort-asc" : "sort-desc");
        }
  
        // Small helpers to keep HTML safe
        function escapeHtml(s) {
          return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
        }
        function cssEscape(s) {
          // basic escape for attribute selector usage
          return String(s).replace(/["\\]/g, "\\$&");
        }
      } catch (e) {
        document.getElementById("detail-note").textContent = "Error loading detail.";
      }
    }


  </script>

</body>
</html>
